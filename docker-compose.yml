version: "3.9"
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: nodejs-photo-manager:local
    container_name: photo-manager
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: production
      PORT: 5000
      # Adjust for your frontend origin in dev; in prod set your real domain(s)
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:5000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5000,http://127.0.0.1:5173
      # CHANGE THIS IN NON-LOCAL ENVIRONMENTS
      DOWNLOAD_SECRET: dev-change-me
      # SSE hardening (optional overrides)
      SSE_MAX_CONN_PER_IP: 2
      SSE_IDLE_TIMEOUT_MS: 300000
    user: "1000:1000"
    volumes:
      # Persist user data and project files outside container
      - ./.projects:/app/.projects
      # Persist runtime configuration (edit on host)
      - ./config.json:/app/config.json
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:5000/api/config').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    # Security hardening (uncomment for stricter runtime)
    # read_only: true
    # tmpfs:
    #   - /tmp
    #   - /app/public
    # cap_drop:
    #   - ALL
    # cap_add: ["CHOWN", "SETGID", "SETUID"]
