services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: nodejs-photo-manager:local
    container_name: photo-manager
    ports:
      - "5000:5000"
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: 5000
      # SSE hardening (optional overrides)
      SSE_MAX_CONN_PER_IP: 2
      SSE_IDLE_TIMEOUT_MS: 300000
    user: "1000:1000"
    restart: unless-stopped
    volumes:
      # Persist database - accessible from host filesystem
      - /var/lib/photo-manager/db:/app/.db
      # Persist project files and images - accessible from host filesystem
      # Change this path to your preferred location on Ubuntu
      - /var/lib/photo-manager/projects:/app/.projects
      # Persist runtime configuration (edit on host)
      - ./config.json:/app/config.json
    healthcheck:
      test: [ "CMD", "node", "-e", "fetch('http://127.0.0.1:5000/api/config').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    # Security hardening (uncomment for stricter runtime)
    # read_only: true
    # tmpfs:
    #   - /tmp
    #   - /app/public
    # cap_drop:
    #   - ALL
    # cap_add: ["CHOWN", "SETGID", "SETUID"]

    # Named volumes for persistent data (survives container rebuilds)
volumes:
  photo-manager-db:
    driver: local
  # photo-manager-projects removed - using bind mount for direct host access
