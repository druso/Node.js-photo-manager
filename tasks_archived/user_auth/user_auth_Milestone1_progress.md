# Milestone 0 Handoff Notes for Milestone 1 Developer

- **[Auth configuration baseline]** Startup now fails fast via `server/services/auth/initAuth.js` calling `ensureAuthConfig()`; deployments must provide `AUTH_ADMIN_BCRYPT_HASH`, `AUTH_JWT_SECRET_ACCESS`, `AUTH_JWT_SECRET_REFRESH`, optional `AUTH_BCRYPT_COST` (defaults to 12). `.env.example` documents generation commands.
- **[Helper modules ready]** Use `passwordUtils.js`, `tokenService.js`, and `authCookieService.js` for login/refresh/logout flow (`server/services/auth/`). Tests under `server/services/auth/__tests__/` illustrate expected behaviour (see `npm test`).
- **[Migration scaffolding]** Draft migrations for `photos.visibility`, `public_links`, and `photo_public_links` live in `server/services/migrations/migrations/`; runner (`runner.js`) supports dry runs. Schema changes are not yet applied automatically.
- **[Docs synced]** High-level design references updated in `PROJECT_OVERVIEW.md`, `SCHEMA_DOCUMENTATION.md`, and `SECURITY.md`; consult these for auth contract, operator checklist, and rollout guidance.
- **[Server startup reminder]** Local dev needs real env secrets or the sample values from `.env.example`. Without them `npm start` will exit with `auth_config_invalid`.

## Suggested Kickoff Checklist

- **[Confirm env]** Ensure your dev/staging environments are populated with the Milestone 0 secrets before implementing `/api/auth/login`.
- **[Plan tests]** Extend existing node:test suites with integration coverage (login/refresh/logout, middleware auth, SSE guards) to maintain parity.
- **[Ops coordination]** Coordinate with ops to plan JWT secret rotation expectations (see `SECURITY.md` Authentication Rollout Checklist) before enabling forced auth in prod.
- **2025-10-04 21:35 CEST — backend auth design**: Drafted plan for `server/routes/auth.js` (login/refresh/logout), new `server/middleware/authenticateAdmin.js` (verifies JWT from Authorization header or `pm_access_token` cookie), and SSE guard integration. Documented cookie strategy (httpOnly Secure access + refresh cookies via `authCookieService`), CORS credential enablement, and supertest coverage for protected routes and SSE handshake.
- **2025-10-04 21:46 CEST — middleware skeleton**: Added `cookie-parser` middleware, switched CORS to `credentials: true`, mounted placeholder `auth` router (to be implemented), and created `server/middleware/authenticateAdmin.js` extracting bearer or cookie tokens via `tokenService.verifyAccessToken()` with logging on failures.
- **2025-10-04 21:58 CEST — backend endpoints**: Implemented `server/routes/auth.js` covering `/login`, `/refresh`, `/logout` using `passwordUtils.verifyAdminPassword()`, `tokenService.issueAccessToken()`, and `authCookieService` helpers; updated `server.js` to protect `/api/*` routes with `authenticateAdmin` and gate `/api/sse` via middleware.
- **2025-10-04 22:32 CEST — frontend auth shell**: Added `AuthProvider` (`client/src/auth/AuthContext.jsx`), login page, and `httpClient` token plumbing; wrapped `App` render in context and gated the SPA so unauthenticated users see the login screen while authenticated admins load the full console.
- **2025-10-04 22:37 CEST — API client hardening**: Migrated `listAllPhotos`, `listAllPendingDeletes`, and project-level `updateKeep`/`updateTags` helpers to `authFetch()` so all admin calls include bearer token + cookies.
- **2025-10-04 22:45 CEST — frontend auth completion**: Finalized admin gating by wrapping `App` with `AuthProvider` in `client/src/main.jsx`, introducing the login screen in `client/src/auth/LoginPage.jsx`, and splitting `client/src/App.jsx` into `AdminApp` protected by `useAuth()` so only authenticated admins load the full console.